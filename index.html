<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VI4Refuel Time Sheets</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1a202c;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 14px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .time-display {
            text-align: right;
        }
        
        .time {
            font-size: 24px;
            font-weight: bold;
            color: #1a202c;
        }
        
        .date {
            font-size: 14px;
            color: #718096;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #718096;
        }
        
        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .driver-list {
            display: grid;
            gap: 12px;
        }
        
        .driver-card {
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .driver-card:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .driver-card.selected {
            border-color: #667eea;
            background: #ebf4ff;
        }
        
        .driver-name {
            font-weight: 600;
            color: #1a202c;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-in {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-out {
            background: #e2e8f0;
            color: #2d3748;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 12px 16px;
            background: #f7fafc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #edf2f7;
        }
        
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            color: #2d3748;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .alert-warning {
            background: #fef5e7;
            border: 1px solid #f9e79f;
            color: #7d6608;
        }
        
        .alert-info {
            background: #ebf4ff;
            border: 1px solid #bee3f8;
            color: #2c5282;
        }
        
        .grid {
            display: grid;
            gap: 16px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .hidden {
            display: none;
        }
        
        .text-center {
            text-align: center;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: #e53e3e;
        }

        .pay-card {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .pay-card.regular {
            background: #ebf8ff;
        }

        .pay-card.overtime {
            background: #fef5e7;
        }

        .pay-card.doubletime {
            background: #fed7d7;
        }

        .pay-card.stat {
            background: #f3e8ff;
        }

        .pay-label {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .pay-amount {
            font-size: 24px;
            font-weight: bold;
            color: #1a202c;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading VI4Refuel Time Sheets...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQK0N2TGAUq9wFluYI_u4O3hBSh0BlEJE",
            authDomain: "vi4refuel-timesheets.firebaseapp.com",
            projectId: "vi4refuel-timesheets",
            storageBucket: "vi4refuel-timesheets.firebasestorage.app",
            messagingSenderId: "344548838616",
            appId: "1:344548838616:web:27287fc119afe0ea579bad"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Application State
        let state = {
            currentUser: null,
            isAdmin: false,
            employees: [],
            timeEntries: [],
            adminPin: '0000',
            selectedEmployee: null,
            currentView: 'clock'
        };

        // BC Stat Holidays 2026
        const statHolidays = [
            '2026-01-01', '2026-02-09', '2026-04-03', '2026-05-18',
            '2026-07-01', '2026-08-03', '2026-09-07', '2026-10-12',
            '2026-11-11', '2026-12-25', '2026-12-26'
        ];

        // ============================================
        // FIREBASE FUNCTIONS
        // ============================================

        // Load settings from Firebase
        async function loadSettings() {
            try {
                const doc = await db.collection('settings').doc('config').get();
                if (doc.exists) {
                    state.adminPin = doc.data().adminPin || '0000';
                } else {
                    // Initialize settings
                    await db.collection('settings').doc('config').set({
                        adminPin: '0000'
                    });
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save admin PIN to Firebase
        async function saveAdminPin(pin) {
            try {
                await db.collection('settings').doc('config').set({
                    adminPin: pin
                });
                state.adminPin = pin;
            } catch (error) {
                console.error('Error saving admin PIN:', error);
                alert('Error saving admin PIN');
            }
        }

        // Load employees from Firebase
        async function loadEmployees() {
            try {
                const snapshot = await db.collection('employees').orderBy('id').get();
                state.employees = [];
                snapshot.forEach(doc => {
                    state.employees.push({ ...doc.data(), docId: doc.id });
                });

                // If no employees, create defaults
                if (state.employees.length === 0) {
                    const defaultEmployees = [
                        { id: 1, name: 'Ian Laird', status: 'clocked-out', pin: '1111' },
                        { id: 2, name: 'Logan Deschenes', status: 'clocked-out', pin: '2222' },
                        { id: 3, name: 'Darin Kourie', status: 'clocked-out', pin: '3333' },
                        { id: 4, name: 'Cole Melvin', status: 'clocked-out', pin: '4444' },
                        { id: 5, name: 'Hillis Halbert', status: 'clocked-out', pin: '5555' },
                        { id: 6, name: 'Julie Dann', status: 'clocked-out', pin: '6666' },
                        { id: 7, name: 'Ryan King', status: 'clocked-out', pin: '7777' },
                        { id: 8, name: 'Jamie Roy', status: 'clocked-out', pin: '8888' },
                        { id: 9, name: 'Adrian Langereis', status: 'clocked-out', pin: '9191' }
                    ];

                    for (const emp of defaultEmployees) {
                        await db.collection('employees').add(emp);
                    }
                    await loadEmployees(); // Reload after creating
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Load time entries from Firebase
        async function loadTimeEntries() {
            try {
                const snapshot = await db.collection('timeEntries').orderBy('clockIn', 'desc').get();
                state.timeEntries = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    state.timeEntries.push({
                        ...data,
                        docId: doc.id,
                        clockIn: data.clockIn.toDate(),
                        clockOut: data.clockOut ? data.clockOut.toDate() : null
                    });
                });
            } catch (error) {
                console.error('Error loading time entries:', error);
            }
        }

        // Add employee to Firebase
        async function addEmployeeToFirebase(employee) {
            try {
                const docRef = await db.collection('employees').add(employee);
                employee.docId = docRef.id;
                state.employees.push(employee);
            } catch (error) {
                console.error('Error adding employee:', error);
                alert('Error adding employee');
            }
        }

        // Update employee in Firebase
        async function updateEmployeeInFirebase(docId, updates) {
            try {
                await db.collection('employees').doc(docId).update(updates);
                const emp = state.employees.find(e => e.docId === docId);
                Object.assign(emp, updates);
            } catch (error) {
                console.error('Error updating employee:', error);
                alert('Error updating employee');
            }
        }

        // Delete employee from Firebase
        async function deleteEmployeeFromFirebase(docId, employeeId) {
            try {
                await db.collection('employees').doc(docId).delete();
                
                // Delete all time entries for this employee
                const entries = await db.collection('timeEntries').where('employeeId', '==', employeeId).get();
                const batch = db.batch();
                entries.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                state.employees = state.employees.filter(e => e.docId !== docId);
                state.timeEntries = state.timeEntries.filter(e => e.employeeId !== employeeId);
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('Error deleting employee');
            }
        }

        // Add time entry to Firebase
        async function addTimeEntryToFirebase(entry) {
            try {
                const docRef = await db.collection('timeEntries').add({
                    ...entry,
                    clockIn: firebase.firestore.Timestamp.fromDate(entry.clockIn),
                    clockOut: entry.clockOut ? firebase.firestore.Timestamp.fromDate(entry.clockOut) : null
                });
                entry.docId = docRef.id;
                state.timeEntries.unshift(entry);
            } catch (error) {
                console.error('Error adding time entry:', error);
                alert('Error adding time entry');
            }
        }

        // Update time entry in Firebase
        async function updateTimeEntryInFirebase(docId, updates) {
            try {
                const firebaseUpdates = {
                    ...updates,
                    clockOut: updates.clockOut ? firebase.firestore.Timestamp.fromDate(updates.clockOut) : null
                };
                await db.collection('timeEntries').doc(docId).update(firebaseUpdates);
                
                const entry = state.timeEntries.find(e => e.docId === docId);
                Object.assign(entry, updates);
            } catch (error) {
                console.error('Error updating time entry:', error);
                alert('Error updating time entry');
            }
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        
        async function init() {
            await loadSettings();
            await loadEmployees();
            await loadTimeEntries();
            
            document.getElementById('app').innerHTML = `
                <!-- Login Screen -->
                <div id="loginScreen">
                    <div class="card" style="max-width: 500px; margin: 100px auto;">
                        <h1 class="text-center">VI4Refuel Time Sheets</h1>
                        <p class="subtitle text-center" style="margin-bottom: 24px;">Select your name and enter PIN</p>
                        
                        <div id="driverButtons"></div>
                        
                        <button class="btn btn-secondary btn-block" onclick="showAdminLogin()">Admin Login</button>
                        
                        <p class="subtitle text-center" style="margin-top: 16px;">Contact administrator if you forgot your PIN</p>
                    </div>
                </div>

                <!-- Main App -->
                <div id="mainApp" class="hidden">
                    <!-- Header -->
                    <div class="card">
                        <div class="header">
                            <div>
                                <h1>VI4Refuel Time Sheets</h1>
                                <p class="subtitle" id="userInfo"></p>
                            </div>
                            <div class="time-display">
                                <div class="time" id="currentTime"></div>
                                <div class="date" id="currentDate"></div>
                            </div>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="card">
                        <div class="tabs">
                            <button class="tab active" onclick="switchTab('clock')">Clock In/Out</button>
                            <button class="tab" onclick="switchTab('timesheet')">Timesheet</button>
                            <button class="tab" onclick="switchTab('payroll')">Hours Summary</button>
                            <button class="tab hidden" id="settingsTab" onclick="switchTab('settings')">Settings</button>
                        </div>
                    </div>

                    <!-- Clock In/Out View -->
                    <div id="clockView">
                        <div class="grid grid-2">
                            <div class="card">
                                <h2 id="driverSectionTitle">Your Profile</h2>
                                <div id="driverSelection"></div>
                            </div>
                            
                            <div class="card">
                                <h2>Clock Action</h2>
                                <div id="clockAction"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Timesheet View -->
                    <div id="timesheetView" class="hidden">
                        <div class="card">
                            <h2>Time Entries</h2>
                            <div id="timesheetTable"></div>
                        </div>
                    </div>

                    <!-- Payroll View -->
                    <div id="payrollView" class="hidden">
                        <div id="payrollContent"></div>
                    </div>

                    <!-- Settings View -->
                    <div id="settingsView" class="hidden">
                        <div class="card">
                            <h2>Admin Settings</h2>
                            <div id="settingsContent"></div>
                        </div>
                    </div>
                </div>
            `;
            
            renderLogin();
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Update clock
        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('currentTime');
            const dateEl = document.getElementById('currentDate');
            if (timeEl) timeEl.textContent = now.toLocaleTimeString();
            if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        // Render login screen
        function renderLogin() {
            const container = document.getElementById('driverButtons');
            if (!container) return;
            container.innerHTML = state.employees.map(emp => `
                <button class="btn btn-primary btn-block" onclick="attemptLogin(${emp.id})">
                    ${emp.name}
                </button>
            `).join('');
        }

        // Login functions
        function attemptLogin(employeeId) {
            const pin = prompt(`Enter PIN for ${state.employees.find(e => e.id === employeeId).name}:`);
            if (!pin) return;
            
            const employee = state.employees.find(e => e.id === employeeId);
            if (employee && pin === employee.pin) {
                state.currentUser = employee;
                state.isAdmin = false;
                state.selectedEmployee = employeeId;
                showMainApp();
            } else {
                alert('Incorrect PIN');
            }
        }

        function showAdminLogin() {
            const pin = prompt('Enter Admin PIN:');
            if (!pin) return;
            
            if (pin === state.adminPin) {
                state.currentUser = { id: 0, name: 'Administrator' };
                state.isAdmin = true;
                showMainApp();
            } else {
                alert('Incorrect Admin PIN');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = state.isAdmin ? 'Administrator Access' : `Driver: ${state.currentUser.name}`;
            
            if (state.isAdmin) {
                document.getElementById('settingsTab').classList.remove('hidden');
                document.getElementById('driverSectionTitle').textContent = 'Select Employee';
            }
            
            renderView();
        }

        function logout() {
            state.currentUser = null;
            state.isAdmin = false;
            state.selectedEmployee = null;
            state.currentView = 'clock';
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Tab switching
        function switchTab(tab) {
            state.currentView = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('clockView').classList.add('hidden');
            document.getElementById('timesheetView').classList.add('hidden');
            document.getElementById('payrollView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');
            
            document.getElementById(tab + 'View').classList.remove('hidden');
            renderView();
        }

        // Render current view
        function renderView() {
            if (state.currentView === 'clock') renderClockView();
            else if (state.currentView === 'timesheet') renderTimesheetView();
            else if (state.currentView === 'payroll') renderPayrollView();
            else if (state.currentView === 'settings') renderSettingsView();
        }

        // Clock View
        function renderClockView() {
            const visibleEmployees = state.isAdmin ? state.employees : state.employees.filter(e => e.id === state.currentUser.id);
            
            document.getElementById('driverSelection').innerHTML = visibleEmployees.map(emp => `
                <div class="driver-card ${state.selectedEmployee === emp.id ? 'selected' : ''}" onclick="selectEmployee(${emp.id})">
                    <div class="driver-name">${emp.name}</div>
                    <div class="status-badge ${emp.status === 'clocked-in' ? 'status-in' : 'status-out'}">
                        ${emp.status === 'clocked-in' ? 'Clocked In' : 'Clocked Out'}
                    </div>
                </div>
            `).join('');
            
            if (state.selectedEmployee) {
                const emp = state.employees.find(e => e.id === state.selectedEmployee);
                const buttonClass = emp.status === 'clocked-out' ? 'btn-success' : 'btn-danger';
                const buttonText = emp.status === 'clocked-out' ? 'Clock In' : 'Clock Out';
                
                document.getElementById('clockAction').innerHTML = `
                    <div class="alert alert-info">
                        <strong>Selected: ${emp.name}</strong><br>
                        Status: ${emp.status === 'clocked-in' ? 'Clocked In' : 'Clocked Out'}
                    </div>
                    <button class="btn ${buttonClass} btn-block" onclick="clockAction()" style="font-size: 20px; padding: 20px;">
                        ${buttonText}
                    </button>
                    <div class="alert alert-warning" style="margin-top: 16px;">
                        <strong>Location tracking enabled:</strong> Your location will be recorded when clocking in/out.
                    </div>
                `;
            } else {
                document.getElementById('clockAction').innerHTML = '<p class="subtitle text-center">Please select an employee to clock in/out</p>';
            }
        }

        function selectEmployee(id) {
            state.selectedEmployee = id;
            renderClockView();
        }

        async function clockAction() {
            if (!state.selectedEmployee) {
                alert('Please select an employee');
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        await processClock(location);
                    },
                    (error) => {
                        alert('Unable to get location. Please enable location services.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        async function processClock(location) {
            const emp = state.employees.find(e => e.id === state.selectedEmployee);
            const now = new Date();
            
            if (emp.status === 'clocked-out') {
                // Clock in
                const newEntry = {
                    id: Date.now(),
                    employeeId: emp.id,
                    employeeName: emp.name,
                    clockIn: now,
                    clockInLocation: location,
                    clockOut: null,
                    clockOutLocation: null
                };
                
                await addTimeEntryToFirebase(newEntry);
                await updateEmployeeInFirebase(emp.docId, { status: 'clocked-in' });
                alert('Clocked in successfully!');
            } else {
                // Clock out
                const entry = state.timeEntries.find(e => e.employeeId === emp.id && !e.clockOut);
                if (entry) {
                    await updateTimeEntryInFirebase(entry.docId, {
                        clockOut: now,
                        clockOutLocation: location
                    });
                }
                await updateEmployeeInFirebase(emp.docId, { status: 'clocked-out' });
                alert('Clocked out successfully!');
            }
            
            renderClockView();
        }

        // Timesheet View
        function renderTimesheetView() {
            const visibleEntries = state.isAdmin ? state.timeEntries : state.timeEntries.filter(e => e.employeeId === state.currentUser.id);
            
            if (visibleEntries.length === 0) {
                document.getElementById('timesheetTable').innerHTML = '<p class="subtitle text-center">No time entries yet</p>';
                return;
            }
            
            const rows = visibleEntries.map(entry => {
                const clockIn = entry.clockIn;
                const clockOut = entry.clockOut;
                const duration = clockOut ? formatDuration(clockIn, clockOut) : 'In Progress';
                
                return `
                    <tr>
                        ${state.isAdmin ? `<td><strong>${entry.employeeName}</strong></td>` : ''}
                        <td>${clockIn.toLocaleString()}</td>
                        <td>${formatLocation(entry.clockInLocation)}</td>
                        <td>${clockOut ? clockOut.toLocaleString() : '<span style="color: #48bb78; font-weight: 600;">In Progress</span>'}</td>
                        <td>${entry.clockOutLocation ? formatLocation(entry.clockOutLocation) : 'N/A'}</td>
                        <td><strong>${duration}</strong></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('timesheetTable').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            ${state.isAdmin ? '<th>Employee</th>' : ''}
                            <th>Clock In</th>
                            <th>Clock In Location</th>
                            <th>Clock Out</th>
                            <th>Clock Out Location</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // Payroll View
        function renderPayrollView() {
            const visibleEmployees = state.isAdmin ? state.employees : state.employees.filter(e => e.id === state.currentUser.id);
            
            const cards = visibleEmployees.map(emp => {
                const entries = state.timeEntries.filter(e => e.employeeId === emp.id && e.clockOut);
                const totals = calculateTotals(emp, entries);
                
                return `
                    <div class="card">
                        <div class="header">
                            <h2>${emp.name}</h2>
                            <div class="text-center">
                                <div style="font-size: 32px; font-weight: bold; color: #667eea;">${totals.hours.toFixed(2)} hrs</div>
                                <div class="subtitle">Total Hours Worked</div>
                            </div>
                        </div>
                        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top: 20px;">
                            <div class="pay-card regular">
                                <div class="pay-label">Regular Hours</div>
                                <div class="pay-amount">${totals.regularHours.toFixed(2)}</div>
                            </div>
                            <div class="pay-card overtime">
                                <div class="pay-label">Overtime Hours (1.5x)</div>
                                <div class="pay-amount">${totals.overtimeHours.toFixed(2)}</div>
                            </div>
                            <div class="pay-card doubletime">
                                <div class="pay-label">Double Time Hours (2x)</div>
                                <div class="pay-amount">${totals.doubleTimeHours.toFixed(2)}</div>
                            </div>
                            <div class="pay-card stat">
                                <div class="pay-label">Stat Holiday Hours</div>
                                <div class="pay-amount">${totals.statHolidayHours.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('payrollContent').innerHTML = cards;
        }

        // Settings View
        async function renderSettingsView() {
            if (!state.isAdmin) return;
            
            const driversList = state.employees.map(emp => `
                <div class="driver-card">
                    <div>
                        <div class="driver-name">${emp.name}</div>
                        <div class="subtitle">PIN: ${emp.pin}</div>
                    </div>
                    <div>
                        <button class="btn btn-primary" style="margin-right: 8px;" onclick="changeDriverPin('${emp.docId}', ${emp.id})">Change PIN</button>
                        <button class="btn btn-danger" onclick="removeDriver('${emp.docId}', ${emp.id}, '${emp.name}')">Remove</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('settingsContent').innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h2>Change Admin PIN</h2>
                    <label>New Admin PIN</label>
                    <input type="text" id="newAdminPin" placeholder="Enter new PIN (4+ digits)">
                    <button class="btn btn-primary" onclick="changeAdminPin()">Update Admin PIN</button>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h2>Add New Driver</h2>
                    <label>Driver Name</label>
                    <input type="text" id="newDriverName" placeholder="Enter driver name">
                    <label>Driver PIN</label>
                    <input type="text" id="newDriverPin" placeholder="Enter PIN (4+ digits)">
                    <button class="btn btn-success" onclick="addDriver()">Add Driver</button>
                </div>
                
                <div>
                    <h2>Manage Drivers</h2>
                    ${driversList}
                </div>
            `;
        }

        // Settings Functions
        async function changeAdminPin() {
            const newPin = document.getElementById('newAdminPin').value;
            if (!newPin || newPin.length < 4) {
                alert('PIN must be at least 4 digits');
                return;
            }
            await saveAdminPin(newPin);
            alert('Admin PIN changed successfully!');
            document.getElementById('newAdminPin').value = '';
        }

        async function addDriver() {
            const name = document.getElementById('newDriverName').value;
            const pin = document.getElementById('newDriverPin').value;
            
            if (!name.trim()) {
                alert('Please enter a driver name');
                return;
            }
            if (!pin || pin.length < 4) {
                alert('PIN must be at least 4 digits');
                return;
            }
            
            const newId = state.employees.length > 0 ? Math.max(...state.employees.map(e => e.id)) + 1 : 1;
            const newDriver = {
                id: newId,
                name: name.trim(),
                status: 'clocked-out',
                pin: pin
            };
            
            await addEmployeeToFirebase(newDriver);
            alert(`Driver ${name} added successfully!`);
            document.getElementById('newDriverName').value = '';
            document.getElementById('newDriverPin').value = '';
            renderSettingsView();
            renderLogin();
        }

        async function changeDriverPin(docId, id) {
            const driver = state.employees.find(e => e.id === id);
            const newPin = prompt(`Enter new PIN for ${driver.name}:`, driver.pin);
            if (!newPin || newPin.length < 4) {
                alert('PIN must be at least 4 digits');
                return;
            }
            await updateEmployeeInFirebase(docId, { pin: newPin });
            alert('PIN updated successfully!');
            renderSettingsView();
        }

        async function removeDriver(docId, id, name) {
            if (!confirm(`Are you sure you want to remove ${name}? This will also delete all their time entries.`)) {
                return;
            }
            await deleteEmployeeFromFirebase(docId, id);
            alert(`${name} has been removed.`);
            renderSettingsView();
            renderLogin();
        }

        // Utility Functions
        function formatLocation(loc) {
            if (!loc) return 'N/A';
            return `${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}`;
        }

        function formatDuration(start, end) {
            const hours = (end - start) / (1000 * 60 * 60);
            const h = Math.floor(hours);
            const m = Math.floor((hours - h) * 60);
            return `${h}h ${m}m`;
        }

        function calculateTotals(employee, entries) {
            let totals = { 
                regularHours: 0, 
                overtimeHours: 0, 
                doubleTimeHours: 0, 
                statHolidayHours: 0, 
                hours: 0 
            };
            
            entries.forEach(entry => {
                const hoursBreakdown = calculateHours(entry, employee);
                totals.regularHours += hoursBreakdown.regularHours;
                totals.overtimeHours += hoursBreakdown.overtimeHours;
                totals.doubleTimeHours += hoursBreakdown.doubleTimeHours;
                totals.statHolidayHours += hoursBreakdown.statHolidayHours;
                totals.hours += hoursBreakdown.totalHours;
            });
            
            return totals;
        }

        function calculateHours(entry, employee) {
            const clockIn = entry.clockIn;
            const clockOut = entry.clockOut;
            const hours = (clockOut - clockIn) / (1000 * 60 * 60);
            
            const isHoliday = statHolidays.includes(clockIn.toISOString().split('T')[0]);
            
            let regularHours = 0, overtimeHours = 0, doubleTimeHours = 0, statHolidayHours = 0;
            
            if (isHoliday) {
                statHolidayHours = hours;
            } else if (hours <= 9) {
                regularHours = hours;
            } else if (hours <= 12) {
                regularHours = 9;
                overtimeHours = hours - 9;
            } else {
                regularHours = 9;
                overtimeHours = 3;
                doubleTimeHours = hours - 12;
            }
            
            return {
                regularHours: regularHours,
                overtimeHours: overtimeHours,
                doubleTimeHours: doubleTimeHours,
                statHolidayHours: statHolidayHours,
                totalHours: hours
            };
        }

        // Initialize app when Firebase is ready
        init();
    </script>
</body>
</html>